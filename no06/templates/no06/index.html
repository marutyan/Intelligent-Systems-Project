<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>動画解析 (no06)</title>
<style>
:root{
  --blue:#0b79d0; --red:#c51616; --blue-h:#0962aa;
  --bg:#f4f7fa;  --card:#fff;
}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}
header{background:var(--blue);color:#fff;padding:12px 1rem;transition:.2s;}
header h1{margin:0;font-size:1.25rem;}
nav{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px;}
button.nav-btn{
  border:0;border-radius:4px;background:#fff;color:var(--blue);
  padding:.45rem .9rem;font-size:.9rem;font-weight:600;
  cursor:pointer;transition:.15s;
}
body.extra-mode button.nav-btn{color:var(--red);}
button.nav-btn:hover{background:var(--blue-h);color:#fff;}
body.extra-mode button.nav-btn:hover{background:#a80f0f;}
main{
  max-width:1024px;margin:1.5rem auto;padding:1rem;background:var(--card);
  border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.08);min-height:60vh;
}
#thumb-modal{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
  align-items:center;justify-content:center;z-index:1000;cursor:zoom-out;
}
#thumb-modal img{max-width:90vw;max-height:90vh;box-shadow:0 0 10px #000;}
ul.simple-list{list-style:none;padding-left:0;}
ul.simple-list li{padding:.3rem 0;border-bottom:1px solid #e3e7ea;}
table{border-collapse:collapse;font-size:.9rem;}
table th,table td{border:1px solid #ccc;padding:.3rem .5rem;}
table thead{background:#f0f4f7;}
</style>
</head>
<body>
<header>
  <h1>動画解析 ans0528~</h1>
  <nav id="nav-bar"></nav>
</header>

<main id="content-area"></main>

<!-- サムネイルモーダル -->
<div id="thumb-modal" onclick="this.style.display='none'">
  <img id="thumb-img" src="" alt="thumbnail">
</div>

<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script>
/* ---------- 共通変数 ---------- */
const area      = document.getElementById('content-area');
const navBar    = document.getElementById('nav-bar');
const headerBar = document.querySelector('header');
let selectedIds = null;          // データ生成で選択した動画 ID 配列
let onceMode    = false;         // ワンクリックモード実行フラグ

/* ---------- ナビ描画 ---------- */
function renderNormalNav(){
  navBar.innerHTML = `
    <button class="nav-btn" id="btn-upload">動画アップロード</button>
    <button class="nav-btn" id="btn-gen">データ生成</button>
    <button class="nav-btn" id="btn-make">分布作成</button>
    <button class="nav-btn" id="btn-show">分布表示</button>
    <button class="nav-btn" id="btn-files">ファイルリスト</button>
    <button class="nav-btn" id="btn-extra">追加機能</button>
  `;
  attachNormalHandlers();
}
function renderExtraNav(){
  navBar.innerHTML = `
    <button class="nav-btn" id="btn-back">通常版に戻る</button>
    <button class="nav-btn" id="btn-upload2">動画アップロード</button>
    <button class="nav-btn" id="btn-once">ワンクリックモード</button>
  `;
  document.getElementById('btn-back').onclick   = leaveExtraMode;
  document.getElementById('btn-upload2').onclick= ()=>loadHTML('/upload/');
  document.getElementById('btn-once').onclick   = ()=>{
      onceMode=true;
      loadHTML('/selectVideos/');
  };
}

/* ---------- 通常モードのハンドラ ---------- */
function attachNormalHandlers(){
  document.getElementById('btn-upload').onclick = ()=>loadHTML('/upload/');
  document.getElementById('btn-gen'   ).onclick = ()=>{onceMode=false;loadHTML('/selectVideos/');};
  document.getElementById('btn-make'  ).onclick = ()=>{
      const url=selectedIds?`/make_distribution/?video_ids=${selectedIds.join(',')}`:'/make_distribution/';
      api(url);
  };
  document.getElementById('btn-show'  ).onclick = ()=>{
      selectedIds?showDistribution(selectedIds):showDistribution();
  };
  document.getElementById('btn-files' ).onclick = ()=>loadHTML('/showDirectory/');
  document.getElementById('btn-extra' ).onclick = enterExtraMode;
}

/* ---------- モード切替 ---------- */
function enterExtraMode(){
  document.body.classList.add('extra-mode');
  headerBar.style.background='var(--red)';
  renderExtraNav();
}
function leaveExtraMode(){
  document.body.classList.remove('extra-mode');
  headerBar.style.background='var(--blue)';
  renderNormalNav();
}

/* ---------- 初期化 ---------- */
renderNormalNav();

/* ---------- 汎用 Ajax ---------- */
function loadHTML(url){ fetch(url).then(r=>r.text()).then(html=>area.innerHTML=html); }
function api(url){ return fetch(url).then(r=>r.json()); }

/* ---------- 分布表示 ---------- */
function showDistribution(ids=null){
  const q=ids?`?video_ids=${ids.join(',')}`:'';
  fetch(`/showDistribution/${q}`).then(r=>r.json()).then(fig=>{
     area.innerHTML=
       '<h3>使用動画</h3><ul id="vid-list" class="simple-list"></ul>'
     + '<div id="plot" style="height:80vh"></div>';

     const ul=document.getElementById('vid-list');
     fig.videos.forEach(v=>{
       const li=document.createElement('li');
       li.textContent=`[${v.id}] ${v.name}`;
       ul.appendChild(li);
     });
     Plotly.newPlot('plot',fig.data,fig.layout);
     document.getElementById('plot').on('plotly_click',onPointClick);
  });
}

/* ---------- サムネイル ---------- */
function onPointClick(ev){
  const [,,thumb]=ev.points[0].customdata;
  fetch(`/getImage/?path=${encodeURIComponent(thumb)}`)
    .then(r=>{if(!r.ok)throw 0;return r.blob();})
    .then(b=>{
      const img=document.getElementById('thumb-img');
      img.src=URL.createObjectURL(b);
      document.getElementById('thumb-modal').style.display='flex';
    })
    .catch(()=>alert('サムネイル取得失敗'));
}

/* ---------- submit 委譲 ---------- */
area.addEventListener('submit',async e=>{
  /* --- 動画アップロード --- */
  if(e.target.id==='upload-form'){
      e.preventDefault();
      const fd=new FormData(e.target);
      const j=await api('/upload/', {method:'POST',body:fd});
      alert(j.message||j.error);
      loadHTML('/upload/'); return;
  }
  /* --- 動画選択フォーム --- */
  if(e.target.id==='video-select-form'){
      e.preventDefault();
      const ids=[...e.target.querySelectorAll('input[name="video_ids"]:checked')]
                .map(cb=>cb.value);
      if(ids.length===0){alert('動画を選択してください');return;}
      selectedIds=ids;   // 記憶

      if(!onceMode){  /* 通常データ生成 */
          const j=await api(`/generateData/?video_ids=${ids.join(',')}`);
          alert(j.message||j.error);
          return;
      }
      /* ------------- ワンクリックモード ------------- */
      try{
        let j=await api(`/generateData/?video_ids=${ids.join(',')}`);
        if(j.error) throw j.error;
        j=await api(`/make_distribution/?video_ids=${ids.join(',')}`);
        if(j.error) throw j.error;
        showDistribution(ids);          // 最後に表示
      }catch(err){
        alert('エラー: '+err);
      }finally{
        onceMode=false;                 // 1 回限り
      }
      return;
  }
});
</script>
</body>
</html>
