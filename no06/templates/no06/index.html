<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>動画解析 (no06)</title>
<style>
:root{--blue:#0b79d0;--red:#c51616;--blue-h:#0962aa;--bg:#f4f7fa;--card:#fff;}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui,sans-serif;background:var(--bg);}
header{background:var(--blue);color:#fff;padding:12px 1rem;transition:.2s;}
header h1{margin:0;font-size:1.25rem;}
nav{margin-top:6px;display:flex;flex-wrap:wrap;gap:6px;}
button.nav-btn{border:0;border-radius:4px;background:#fff;color:var(--blue);
  padding:.45rem .9rem;font-size:.9rem;font-weight:600;cursor:pointer;transition:.15s;}
body.extra-mode button.nav-btn{color:var(--red);}
button.nav-btn:hover{background:var(--blue-h);color:#fff;}
body.extra-mode button.nav-btn:hover{background:#a80f0f;color:#fff;}
main{max-width:1024px;margin:1.5rem auto;padding:1rem;background:var(--card);
  border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.08);min-height:60vh;}
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);
  align-items:center;justify-content:center;z-index:1000;cursor:zoom-out;}
#modal img{max-width:90vw;max-height:90vh;box-shadow:0 0 10px #000;}
ul.simple-list{list-style:none;padding-left:0;}
ul.simple-list li{padding:.3rem 0;border-bottom:1px solid #e3e7ea;}
</style>
</head>
<body>
<header><h1>動画解析 ans0528~</h1><nav id="nav"></nav></header>
<main id="area"></main>

<!-- 画像／スライドショー共通モーダル -->
<div id="modal"></div>

<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
<script>
/* ── 状態変数 ─────────────────────────── */
const area=document.getElementById('area');
const nav =document.getElementById('nav');
const modal=document.getElementById('modal');
let slideTimer=null, selectedIds=null, onceMode=false;

/* ── ナビゲーション描画 ─────────────────── */
function renderNormal(){
  nav.innerHTML=`<button class="nav-btn" id="u">動画アップロード</button>
  <button class="nav-btn" id="g">データ生成</button>
  <button class="nav-btn" id="m">分布作成</button>
  <button class="nav-btn" id="s">分布表示</button>
  <button class="nav-btn" id="f">ファイルリスト</button>
  <button class="nav-btn" id="x">追加機能</button>`;
  document.getElementById('u').onclick=()=>load('/upload/');
  document.getElementById('g').onclick=()=>{onceMode=false;load('/selectVideos/');};
  document.getElementById('m').onclick=()=>api(selectedIds?`/make_distribution/?video_ids=${selectedIds}`:'/make_distribution/');
  document.getElementById('s').onclick=()=>show(selectedIds);
  document.getElementById('f').onclick=()=>load('/showDirectory/');
  document.getElementById('x').onclick=enterExtra;
}
function renderExtra(){
  nav.innerHTML=`<button class="nav-btn" id="b">通常版に戻る</button>
  <button class="nav-btn" id="u2">動画アップロード</button>
  <button class="nav-btn" id="o">ワンクリックモード</button>`;
  document.getElementById('b').onclick=leaveExtra;
  document.getElementById('u2').onclick=()=>load('/upload/');
  document.getElementById('o').onclick=()=>{onceMode=true;load('/selectVideos/');};
}
renderNormal();

/* ── ヘッダー色切替 ──────────────────── */
function enterExtra(){document.body.classList.add('extra-mode');document.querySelector('header').style.background='var(--red)';renderExtra();}
function leaveExtra(){document.body.classList.remove('extra-mode');document.querySelector('header').style.background='var(--blue)';renderNormal();}

/* ── 汎用 fetch ─────────────────────── */
const load=u=>fetch(u).then(r=>r.text()).then(ht=>area.innerHTML=ht);
const api =(u,o)=>fetch(u,o).then(r=>r.json()).then(j=>{alert(j.message||j.error);return j;});

/* ── モーダル操作 ──────────────────── */
function clearSlide(){clearInterval(slideTimer);slideTimer=null;}
function showImage(path){
  clearSlide();
  modal.innerHTML=`<img src="/getImage/?path=${encodeURIComponent(path)}">`;
  modal.style.display='flex';
}
function startSlide(vid){
  fetch(`/getThumbList/?video_id=${vid}`).then(r=>r.json()).then(d=>{
    if(d.error){alert(d.error);return;}
    let idx=0;
    modal.innerHTML='<img>';
    const img=modal.querySelector('img');
    img.src=`/getImage/?path=${encodeURIComponent(d.thumbs[0])}`;
    modal.style.display='flex';
    clearSlide();
    slideTimer=setInterval(()=>{
      idx=(idx+1)%d.thumbs.length;
      img.src=`/getImage/?path=${encodeURIComponent(d.thumbs[idx])}`;
    },1000);
  });
}
modal.onclick=()=>{modal.style.display='none';clearSlide();};

/* ── 分布表示 ───────────────────────── */
function show(ids=null){
  const q=ids?`?video_ids=${ids}`:'';
  fetch(`/showDistribution/${q}`).then(r=>r.json()).then(fig=>{
    area.innerHTML='<h3>使用動画</h3><ul id="vl" class="simple-list"></ul><div id="p" style="height:80vh"></div>';
    const ul=document.getElementById('vl');
    fig.videos.forEach(v=>{const li=document.createElement('li');li.textContent=`[${v.id}] ${v.name}`;li.dataset.id=v.id;ul.appendChild(li);});
    ul.onclick=e=>{if(!e.target.dataset.id)return;startSlide(e.target.dataset.id);};

    Plotly.newPlot('p',fig.data,fig.layout);
    document.getElementById('p')
      .on('plotly_click',ev=>{
          const [,,thumb]=ev.points[0].customdata;
          showImage(thumb);
      });
  });
}

/* ── submit イベント委譲 ───────────────── */
area.addEventListener('submit',async e=>{
  if(e.target.id==='upload-form'){
     e.preventDefault();
     const fd=new FormData(e.target);
     await api('/upload/',{method:'POST',body:fd});
     load('/upload/'); return;
  }
  if(e.target.id==='video-select-form'){
     e.preventDefault();
     const ids=[...e.target.querySelectorAll('input[name="video_ids"]:checked')].map(cb=>cb.value);
     if(!ids.length){alert('動画を選択してください');return;}
     selectedIds=ids.join(',');
     if(!onceMode){await api(`/generateData/?video_ids=${selectedIds}`);return;}
     await api(`/generateData/?video_ids=${selectedIds}`);
     await api(`/make_distribution/?video_ids=${selectedIds}`);
     show(ids);
     onceMode=false;
  }
});
</script>
</body>
</html>
